<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n de Turnos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app-container" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="bg-white shadow-lg rounded-xl mb-6 p-4">
            <div class="flex flex-col sm:flex-row justify-between items-center">
                <h1 class="text-3xl font-extrabold text-blue-800 mb-2 sm:mb-0">
                    Sistema de Gesti√≥n de Negocio
                </h1>
                <div id="user-info" class="text-sm text-gray-600 flex items-center space-x-4">
                    <span id="user-id-display">Cargando usuario...</span>
                    <button id="logout-button" class="px-3 py-1 bg-red-500 text-white text-xs font-medium rounded-lg hover:bg-red-600 transition">
                        Cerrar Sesi√≥n
                    </button>
                </div>
            </div>
            <nav class="mt-4 border-t pt-4">
                <div class="flex space-x-2 sm:space-x-4 overflow-x-auto">
                    <button data-view="servicios" class="nav-tab bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200">
                        Servicios
                    </button>
                    <button data-view="clientes" class="nav-tab text-gray-700 hover:bg-gray-100 py-2 px-4 rounded-lg transition duration-200">
                        Clientes
                    </button>
                    <button data-view="turnos" class="nav-tab text-gray-700 hover:bg-gray-100 py-2 px-4 rounded-lg transition duration-200">
                        Turnos (Agendar)
                    </button>
                    <button data-view="reportes" class="nav-tab text-gray-700 hover:bg-gray-100 py-2 px-4 rounded-lg transition duration-200">
                        Reportes
                    </button>
                </div>
            </nav>
        </header>

        <main id="content-container" class="space-y-6">
            </main>

        <div id="message-container" class="fixed top-4 right-4 z-50"></div>
    </div>

    <script>
        // --- CONFIGURACI√ìN Y VARIABLES GLOBALES ---
        const API_URL = 'http://localhost:5000/api';
        let token = localStorage.getItem('activeUserToken');
        let activeUserRole = localStorage.getItem('activeUserRole');
        let activeUserName = localStorage.getItem('activeUserName');

        let currentView = 'servicios';
        
        // Listas locales para renderizado (se llenan desde el backend)
        let services = []; 
        let clients = [];  
        let professionals = []; // NUEVO: Necesario para crear turnos
        let appointments = []; 

        // --- FUNCIONES DE UTILIDAD ---
        function showMessage(message, type = 'success') {
            const container = document.getElementById('message-container');
            const color = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-yellow-500';
            const element = document.createElement('div');
            element.className = `${color} text-white px-6 py-3 rounded-lg shadow-xl mb-3 transition-all duration-300 transform translate-x-0 opacity-100`;
            element.textContent = message;
            
            container.appendChild(element);
            setTimeout(() => {
                element.classList.replace('opacity-100', 'opacity-0');
                setTimeout(() => element.remove(), 500);
            }, 4000);
        }

        // --- 1. INICIALIZACI√ìN Y CARGA DE DATOS ---
        async function initApp() {
            if (!token || activeUserRole !== 'gestor') {
                alert('Acceso Denegado. Inicia sesi√≥n como Gestor.');
                window.location.href = 'login.html';
                return;
            }

            document.getElementById('user-id-display').innerHTML = `
                Usuario: <strong class="text-blue-600">${activeUserName || 'Gestor'}</strong>
            `;

            document.getElementById('logout-button').onclick = () => {
                localStorage.clear();
                window.location.href = 'login.html';
            };

            await loadDataFromBackend();
            renderView(currentView);
        }

        async function loadDataFromBackend() {
            try {
                const headers = { 'Content-Type': 'application/json', 'x-access-token': token };

                // 1. Servicios
                const resServ = await fetch(`${API_URL}/servicios`, { headers });
                const dataServ = await resServ.json();
                // Mapear campos de BD a Frontend
                services = dataServ.map(s => ({
                    id: s.id_servicio,
                    name: s.nombre,
                    duration: s.duracion_minutos,
                    price: 0, // Tu BD no tiene precio a√∫n, ponemos 0 por defecto
                    id_negocio: s.id_negocio
                }));

                // 2. Clientes
                const resCli = await fetch(`${API_URL}/clientes`, { headers });
                const dataCli = await resCli.json();
                clients = dataCli.map(c => ({
                    id: c.id_cliente,
                    name: c.nombre,
                    phone: c.telefono,
                    email: 'No registrado' // Tu BD no tiene email en tabla cliente
                }));

                // 3. Profesionales (NUEVO: Requerido para Turnos)
                const resProf = await fetch(`${API_URL}/profesionales`, { headers });
                const dataProf = await resProf.json();
                professionals = dataProf.map(p => ({
                    id: p.id_profesional,
                    name: p.nombre
                }));

                // 4. Turnos
                const resTurnos = await fetch(`${API_URL}/turnos`, { headers });
                const dataTurnos = await resTurnos.json();
                appointments = dataTurnos.map(t => ({
                    id: t.id_turno,
                    clientId: t.id_cliente,
                    serviceId: t.id_servicio,
                    profesionalId: t.id_profesional,
                    // Combinar fecha y hora para el frontend
                    dateTime: `${t.fecha}T${t.hora}`, 
                    status: t.estado
                })).sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime));

                console.log("Datos sincronizados con Backend");

            } catch (error) {
                console.error("Error cargando datos:", error);
                showMessage("Error de conexi√≥n con el servidor.", "error");
            }
        }

        // --- 2. RENDERIZADO Y NAVEGACI√ìN ---

        document.querySelectorAll('.nav-tab').forEach(button => {
            button.addEventListener('click', (e) => {
                const newView = e.target.getAttribute('data-view');
                renderView(newView);
            });
        });

        function renderView(viewName) {
            currentView = viewName;
            const container = document.getElementById('content-container');
            container.innerHTML = '';

            document.querySelectorAll('.nav-tab').forEach(btn => {
                const isActive = btn.getAttribute('data-view') === viewName;
                btn.className = isActive
                    ? 'nav-tab bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200'
                    : 'nav-tab text-gray-700 hover:bg-gray-100 py-2 px-4 rounded-lg transition duration-200';
            });

            switch (viewName) {
                case 'servicios':
                    container.innerHTML = renderServicesView();
                    setupServiceEventListeners();
                    break;
                case 'clientes':
                    container.innerHTML = renderClientsView();
                    setupClientEventListeners();
                    break;
                case 'turnos':
                    container.innerHTML = renderAppointmentsView();
                    setupAppointmentEventListeners();
                    break;
                case 'reportes':
                    container.innerHTML = renderReportsView();
                    break;
                default:
                    container.innerHTML = `<div class="text-center p-10">Vista no encontrada.</div>`;
            }
        }

        // --- 3. VISTAS (HTML TEMPLATES) ---

        function renderServicesView() {
            const serviceList = services.map(s => `
                <div class="flex justify-between items-center bg-white p-4 rounded-lg shadow-sm border border-gray-100 hover:shadow-md transition">
                    <div>
                        <p class="text-lg font-semibold text-gray-800">${s.name}</p>
                        <p class="text-sm text-gray-500">${s.duration} min</p>
                    </div>
                    <button class="text-gray-400 hover:text-red-500 cursor-not-allowed" title="Eliminar no disponible a√∫n">üóëÔ∏è</button>
                </div>
            `).join('');

            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 p-6 bg-white rounded-xl shadow-xl">
                        <h2 class="text-2xl font-bold text-blue-800 mb-4 border-b pb-2">Crear Servicio</h2>
                        <form id="service-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Nombre</label>
                                <input type="text" id="service-name" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border" placeholder="Ej: Corte">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Duraci√≥n (min)</label>
                                <input type="number" id="service-duration" required min="1" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border" value="30">
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition">Guardar</button>
                        </form>
                    </div>
                    <div class="lg:col-span-2 p-6 bg-white rounded-xl shadow-xl">
                        <h2 class="text-2xl font-bold text-blue-800 mb-4">Servicios (${services.length})</h2>
                        <div class="space-y-3">${services.length > 0 ? serviceList : '<p class="text-gray-500">No hay servicios.</p>'}</div>
                    </div>
                </div>
            `;
        }

        function renderClientsView() {
            const clientList = clients.map(c => `
                <div class="flex justify-between items-start bg-white p-4 rounded-lg shadow-sm border border-gray-100 hover:shadow-md transition">
                    <div>
                        <p class="text-lg font-semibold text-gray-800">${c.name}</p>
                        <p class="text-sm text-gray-500">Tel: ${c.phone}</p>
                    </div>
                </div>
            `).join('');

            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 p-6 bg-white rounded-xl shadow-xl">
                        <h2 class="text-2xl font-bold text-blue-800 mb-4 border-b pb-2">Registrar Cliente</h2>
                        <form id="client-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Nombre Completo</label>
                                <input type="text" id="client-name" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Tel√©fono</label>
                                <input type="tel" id="client-phone" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border">
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition">Guardar</button>
                        </form>
                    </div>
                    <div class="lg:col-span-2 p-6 bg-white rounded-xl shadow-xl">
                        <h2 class="text-2xl font-bold text-blue-800 mb-4">Clientes (${clients.length})</h2>
                        <div class="space-y-3">${clients.length > 0 ? clientList : '<p class="text-gray-500">No hay clientes.</p>'}</div>
                    </div>
                </div>
            `;
        }

        function renderAppointmentsView() {
            const clientOptions = clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            const serviceOptions = services.map(s => `<option value="${s.id}">${s.name} (${s.duration} min)</option>`).join('');
            const profOptions = professionals.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            
            const now = new Date().toISOString().slice(0, 16);

            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 p-6 bg-white rounded-xl shadow-xl">
                        <h2 class="text-2xl font-bold text-blue-800 mb-4 border-b pb-2">Agendar Turno</h2>
                        <form id="appointment-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Cliente</label>
                                <select id="appointment-client" required class="mt-1 block w-full rounded-lg border p-3 bg-white">
                                    <option value="" disabled selected>Seleccionar...</option>
                                    ${clientOptions}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Profesional</label>
                                <select id="appointment-prof" required class="mt-1 block w-full rounded-lg border p-3 bg-white">
                                    <option value="" disabled selected>Seleccionar...</option>
                                    ${profOptions}
                                </select>
                                ${professionals.length === 0 ? '<p class="text-xs text-red-500">¬°Crea un profesional en BD primero!</p>' : ''}
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Servicio</label>
                                <select id="appointment-service" required class="mt-1 block w-full rounded-lg border p-3 bg-white">
                                    <option value="" disabled selected>Seleccionar...</option>
                                    ${serviceOptions}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Fecha y Hora</label>
                                <input type="datetime-local" id="appointment-datetime" required min="${now}" class="mt-1 block w-full rounded-lg border p-3">
                            </div>
                            <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition">Confirmar Turno</button>
                        </form>
                    </div>

                    <div class="lg:col-span-2 p-6 bg-white rounded-xl shadow-xl">
                        <h2 class="text-2xl font-bold text-blue-800 mb-4">Pr√≥ximos Turnos</h2>
                        <div class="space-y-3">
                            ${renderUpcomingAppointments()}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderUpcomingAppointments() {
            const upcoming = appointments.filter(a => new Date(a.dateTime) >= new Date() && a.status !== 'cancelado');
            if (upcoming.length === 0) return '<p class="text-gray-500">No hay turnos pendientes.</p>';

            return upcoming.map(a => {
                const client = clients.find(c => c.id === a.clientId) || { name: 'Desconocido' };
                const service = services.find(s => s.id === a.serviceId) || { name: 'Desconocido', duration: 0 };
                const prof = professionals.find(p => p.id === a.profesionalId) || { name: 'Desconocido' };
                const dateObj = new Date(a.dateTime);

                return `
                    <div class="flex items-start bg-white p-4 rounded-lg shadow-md border-l-4 border-blue-500">
                        <div class="flex-grow">
                            <p class="text-lg font-bold text-gray-900">
                                ${dateObj.toLocaleDateString()} ${dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                            </p>
                            <p class="text-md font-semibold text-gray-700">${service.name} con ${client.name}</p>
                            <p class="text-sm text-gray-500">Prof: ${prof.name} | ${service.duration} min</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderReportsView() {
            return `
                <div class="p-6 bg-white rounded-xl shadow-xl text-center">
                    <h2 class="text-2xl font-bold text-gray-800">Reportes</h2>
                    <div class="grid grid-cols-2 gap-4 mt-6">
                        <div class="p-4 bg-blue-50 rounded-lg">
                            <p class="text-3xl font-bold text-blue-600">${services.length}</p>
                            <p>Servicios</p>
                        </div>
                        <div class="p-4 bg-green-50 rounded-lg">
                            <p class="text-3xl font-bold text-green-600">${clients.length}</p>
                            <p>Clientes</p>
                        </div>
                        <div class="p-4 bg-yellow-50 rounded-lg">
                            <p class="text-3xl font-bold text-yellow-600">${appointments.length}</p>
                            <p>Turnos Totales</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- 4. MANEJADORES DE EVENTOS (POST REQUESTS) ---

        function setupServiceEventListeners() {
            const form = document.getElementById('service-form');
            if (form) {
                form.onsubmit = async (e) => {
                    e.preventDefault();
                    const name = document.getElementById('service-name').value.trim();
                    const duration = parseInt(document.getElementById('service-duration').value);

                    try {
                        const res = await fetch(`${API_URL}/servicios`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'x-access-token': token },
                            body: JSON.stringify({
                                nombre: name,
                                duracion_minutos: duration,
                                id_negocio: 1 // ID hardcodeado o din√°mico si lo tienes
                            })
                        });

                        if (res.ok) {
                            showMessage('Servicio creado exitosamente');
                            await loadDataFromBackend();
                            renderView('servicios');
                        } else {
                            const err = await res.json();
                            showMessage(`Error: ${err.error}`, 'error');
                        }
                    } catch (e) { showMessage("Error de conexi√≥n", "error"); }
                };
            }
        }

        function setupClientEventListeners() {
            const form = document.getElementById('client-form');
            if (form) {
                form.onsubmit = async (e) => {
                    e.preventDefault();
                    const name = document.getElementById('client-name').value.trim();
                    const phone = document.getElementById('client-phone').value.trim();

                    try {
                        const res = await fetch(`${API_URL}/clientes`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'x-access-token': token },
                            body: JSON.stringify({
                                nombre: name,
                                telefono: phone,
                                id_negocio: 1
                            })
                        });

                        if (res.ok) {
                            showMessage('Cliente registrado');
                            await loadDataFromBackend();
                            renderView('clientes');
                        } else {
                            const err = await res.json();
                            showMessage(`Error: ${err.error}`, 'error');
                        }
                    } catch (e) { showMessage("Error de conexi√≥n", "error"); }
                };
            }
        }

        function setupAppointmentEventListeners() {
            const form = document.getElementById('appointment-form');
            if (form) {
                form.onsubmit = async (e) => {
                    e.preventDefault();
                    const clientId = document.getElementById('appointment-client').value;
                    const profId = document.getElementById('appointment-prof').value;
                    const serviceId = document.getElementById('appointment-service').value;
                    const datetimeVal = document.getElementById('appointment-datetime').value;

                    if (!clientId || !profId || !serviceId || !datetimeVal) {
                        showMessage("Completa todos los campos", "warning");
                        return;
                    }

                    // Separar fecha y hora para el backend (YYYY-MM-DD y HH:MM)
                    const dateObj = new Date(datetimeVal);
                    const fecha = datetimeVal.split('T')[0];
                    const hora = datetimeVal.split('T')[1];

                    try {
                        const res = await fetch(`${API_URL}/turnos`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'x-access-token': token },
                            body: JSON.stringify({
                                id_cliente: clientId,
                                id_profesional: profId,
                                id_servicio: serviceId,
                                fecha: fecha,
                                hora: hora
                            })
                        });

                        if (res.ok) { // C√≥digo 201
                            showMessage('¬°Turno agendado con √©xito!');
                            await loadDataFromBackend();
                            renderView('turnos');
                        } else {
                            const err = await res.json();
                            // Manejo espec√≠fico del error de conflicto (C√≥digo 500 o 409 seg√∫n tu backend)
                            if (err.error && err.error.includes('ocupado')) {
                                showMessage('‚ö†Ô∏è CONFLICTO: El profesional ya est√° ocupado en ese horario.', 'error');
                            } else {
                                showMessage(`Error: ${err.error}`, 'error');
                            }
                        }
                    } catch (e) { showMessage("Error de conexi√≥n", "error"); }
                };
            }
        }

        // Iniciar
        window.onload = initApp;

    </script>
</body>
</html>
